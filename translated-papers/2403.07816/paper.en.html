<!DOCTYPE html>
<html lang="en" data-lt-installed="true"><head>
  <meta charset="UTF-8">
  <title>Title</title>
  <script>
    const text = '' +
      '[MISSING_PAGE_FAIL:1]\n' +
      '\n' +
      'synchronized fashion, and the communication cost increases with the number of experts due to all-to-all communication.\n' +
      '\n' +
      'In this paper, we aim for the best of both worlds, combining the advantages of Branch-Train-Merge and Mixture-of-Experts, while mitigating their disadvantages. We achieve this by training multiple expert LLMs separately as in the Branch-Train-Merge method, but subsequently combine those experts into a single model using an MoE architecture. More specifically, the feedforward sublayers from all the expert LLMs are brought together into a single MoE module at each layer, and a router network selects which feedforward expert to use at every token. We merge other modules of the expert LLMs, including self-attention layers, by simply averaging their weights. Then the resulting model is MoE-finetuned on all the combined data by continuing training, so that the router can learn to mix the expert feedforward (FF) modules. Figure 1 shows an overview of this method, which we call _Branch-Train-MiX_ (BTX).\n' +
      '\n' +
      'The main advantage of BTX compared to MoE is that expert training is embarrassingly parallel and asynchronous, reducing communication cost and increasing training throughput. Compared to Branch-Train-Merge, the final BTX model is a unified neural network that can be finetuned or used like any other standard LLM. The final BTX model will not significantly increase inference FLOPs compared to the seed model since it is sparsely activated, despite having a much larger number of parameters.\n' +
      '\n' +
      'We conduct our experiments using Llama-2 7B (Touvron et al., 2023) as a seed model and train expert LLMs on different subsets of data corresponding to the domains of math, code and Wikipedia. With the original Llama-2 7B weights added as a fourth expert, we finetune the combined MoE model for a relatively short period compared to the pretraining process. The resulting BTX model brings significant improvements over the seed model on tasks across various domains, especially bridging the gap with specialized models on math and code related tasks, while retaining performance on the original capabilities where specialized models suffer from catastrophic forgetting. BTX outperforms BTM on all tasks demonstrating the benefits of learnt routing through MoE finetuning. Compared to purely MoE training such as sparse upcycling, BTX is more compute efficient with higher training throughput and more balanced performance across tasks in different domains.\n' +
      '\n' +
      '## 2 Related Work\n' +
      '\n' +
      'Asynchronous parallel trainingReducing communication between training workers for computational efficiency is a major topic of study for training deep learning systems. Zhang et al. (2015) introduced a method that allows model instances on different workers to diverge from each other, thus eliminating the constant need of synchronization. Instead, the workers are loosely synchronized to master weights using elastic averaging from time to time. A more recent work by Douillard et al. (2023) showed that less frequent synchronization of diverged workers by averaging their weight changes and applying Nesterov momentum works well in practice\n' +
      '\n' +
      'Figure 1: **The Branch-Train-Mix (BTQ) method has three steps: 1) branch from a pretrained seed LLM by making multiple copies of it; 2) train those copies separately on different subsets of data to obtain expert LLMs; 3) mix those expert LLMs by combining them into a single LLM using mixture-of-experts feedforward (FF) layers, and finetuning the overall unified model.**\n' +
      '\n' +
      'for training LLMs. The Branch-Train-Merge method (Li et al., 2022; Gururangan et al., 2023) takes parallel training to the extreme by running multiple training processes completely independently. Each training process uses specific domain data, thus the corresponding model becomes an expert in that domain. Finally, the output distributions of those expert models are averaged to make a next token prediction. Which experts to average is decided by classifying the input into one or more of the domains. Wortsman et al. (2022) showed simply averaging parameters of separately trained models improves performance, but the models only differed in their hyperparameters.\n' +
      '\n' +
      'Mixture-of-ExperstMoE is used to scale deep networks in Shazeer et al. (2017) using a simple Top-K routing scheme. Since the routing decisions are discrete and thus cannot be trained by gradient descent, various training methods have been explored for the Transformer architecture (Fedus et al., 2022; Lewis et al., 2021). Surprisingly Roller et al. (2021) showed that even a fixed routing scheme without any learning works well, if the routing is done via a random mapping based on input tokens. In larger scale experiments with recent LLMs, Jiang et al. (2024) demonstrated that the MoE approach can match the performance of dense LLM counterparts using a much smaller number of active parameters. A study by Dai et al. (2024) showed the advantage of more fine-grained experts, as well as having a shared expert that always stay active. More similar to our work, Gururangan et al. (2021) makes experts in feedforward layers specialize to specific domains using a domain-conditioned fixed routing, but it lacks the asynchronous training of our approach.\n' +
      '\n' +
      'Continual learningOur method relates to continual learning (Awasthi and Sarawagi, 2019) because domain experts are trained on datasets with different distributions from the initial data used for training the seed model, which is implemented by continued training after branching. Specifically, our approach is related to parameter isolation methods (Lange et al., 2019) as we have different parameters for different domains. Aljundi et al. (2016) also creates a new copy of a model to train on each domain. Rusu et al. (2016) adds a new model with a new domain, but connects it to the previous models so the previously learned features can be used. Roziere et al. (2023) showed continual training of a seed LLM on a specific domain of code can produce a strong domain expert model, and this converges much faster than starting from scratch. For training a math expert, starting from a code expert rather than a general LLM was shown to be more beneficial (Shao et al., 2024; Azerbayev et al., 2023).\n' +
      '\n' +
      '## 3 Branch-Train-Mix\n' +
      '\n' +
      'Given an existing LLM \\(\\mathcal{M}\\) which has been pretrained on a large corpora covering a wide variety of topics, we aim to improve its performance on \\(N\\) areas of expertise. This is achieved by continued pretraining with corresponding training datasets \\(\\mathcal{D}\\coloneqq\\{D_{1},\\dots,D_{N}\\}\\), each related to a specific knowledge domain such as math, code, etc. The proposed method contains three stages: Branch, Train, and MiX.\n' +
      '\n' +
      '### Branch & Train: Embarrassingly Parallel Expert Training\n' +
      '\n' +
      'Initializing from the seed model \\(\\mathcal{M}\\), we train \\(N\\) expert LLMs \\(\\{\\mathcal{M}_{1},\\dots,\\mathcal{M}_{N}\\}\\), with each model \\(\\mathcal{M}_{i}\\) being trained on the corresponding dataset \\(D_{i}\\) in the same manner as during pretraining, using the usual language modeling objective. Since each expert model \\(\\mathcal{M}_{i}\\) can be trained in complete separation from the others, the whole training process becomes \\(N\\)-way embarrassingly parallel. This training paradigm has several benefits in large-scale distributed training. It allows linear scaling of overall training throughput when scaling up the size of compute, while joint training often faces uncertain performance from increasing batch size. It has lower all-to-all communication cost. It is also more resilient, as a single training failure will only affect one of the \\(N\\) training processes instead of halting the entire training.\n' +
      '\n' +
      'After all the expert training is finished, we will end up with \\(N\\) different LLMs, with each specializing in a specific distribution. At this point, the Branch-Train-Merge method (Li et al., 2022; Gururangan et al., 2023) uses these domain experts as is, choosing which expert to use by determining which domain the input belongs to at inference time. Usually multiple experts are chosen, and their final output distributions are simply averaged to generate the next token. Our BTX approach, in contrast, merges these domain experts back into a single LLM that is finetuned further, as we will describe in the next section.\n' +
      '\n' +
      '### MiX: Combining Separate Experts to be a Mixture-of-Experts\n' +
      '\n' +
      'We employ a Mixture-of-Experts approach to combine the domain expert models \\(\\mathcal{M}_{i}\\). However, instead of using the classical procedure of mixing the final outputs from \\(\\mathcal{M}_{i}\\), we do a more fine-grained mixing by performing MoE within each layer of a Transformer. In particular, we combine the different feedforward sublayers from the domain experts into a single MoE sublayer. If \\(\\mathsf{FF}^{l}_{i}(x)\\) is the feedforward sublayer at the \\(l\\)-th layer of the \\(i\\)-th domain expert \\(\\mathcal{M}_{i}\\), then the combined MoE layer for input representation \\(x\\) at layer \\(l\\) will compute:\n' +
      '\n' +
      '\\[\\mathsf{FF}^{l}_{\\text{MoE}}(x)=\\sum_{i=1}^{N}g_{i}(W_{l}x)\\mathsf{FF}^{l}_{i} (x).\\]\n' +
      '\n' +
      'Here \\(W_{l}\\) is a linear transformation and \\(g\\) is a routing function, which usually has sparse output and hence switches on only some experts. Since we can skip computing \\(\\mathsf{FF}^{l}_{i}(x)\\) if the corresponding router output is zero, the actual computation of \\(\\mathsf{FF}^{l}_{\\text{MoE}}(x)\\) will be much more efficient than computing all domain experts. However, routing decisions can change from token to token, so one input sequence can employ all the domain expert FF layers if needed, even when only a few are accessed at any given token. In our experiments, we use Top-k (k=2) routing where \\(g(W_{l}x)=\\text{SoftMax}(\\text{TopK}(W_{l}x))\\), unless otherwise stated.\n' +
      '\n' +
      'For the self-attention sublayers, we combine the different domain experts by simply averaging their weights. The motivation behind this is the assumption that the self-attention layers are less domain specialized than the feedforward layers. We do the same averaging for the remaining parameters (embeddings, etc.) as well.\n' +
      '\n' +
      'Note that the only new parameters we introduce are the router\'s transformation parameters \\(W_{l}\\), which are negligible in size compared to the rest of the network. Nevertheless, those new parameters need to be finetuned, so the router can make optimal decisions in selecting which domain \\(\\mathsf{FF}_{i}\\) to use. In addition, finetuning is helpful because the self-attention weights are constructed by averaging, and are likely not optimal. Overall, the entire system has not been optimized for working together at all in the embarrassingly parallel training framework, but our hypothesis is that even a small amount of combined finetuning might make large improvements.\n' +
      '\n' +
      '### Variations\n' +
      '\n' +
      'We also experimented with several variations of our method.\n' +
      '\n' +
      'Load balancingA common problem with MoE is the emergence of dead experts, which do not get activated by the router at all. Common routing methods like Top-k are unlikely to escape from such a situation because a dead expert is never in the top-k selection, and therefore never receives a training signal. Load balancing offers a simple solution by adding an extra loss term that encourages the experts to be utilized equally. We use a loss term similar to (Fedus et al., 2022):\n' +
      '\n' +
      '\\[\\mathcal{L}_{\\text{LB}}=\\alpha N\\sum_{i=1}^{N}u_{i}p_{i}\\quad\\text{where }u_{i}=\\frac{1}{|\\mathcal{B}|}\\sum_{x\\in\\mathcal{B}}g_{i}(W_{l}x)\\text{ and }p_{i}=\\frac{1}{|\\mathcal{B}|}\\sum_{x\\in\\mathcal{B}}\\text{SoftMax}_{i}(W_{l}x).\\]\n' +
      '\n' +
      'Here \\(\\mathcal{B}\\) is the current data batch, and \\(\\alpha\\) is a hyperparameter. This loss is computed in each layer and added to the NLL loss.\n' +
      '\n' +
      'Routing methodBesides Top-k routing, we also experiment with other routing methods:\n' +
      '\n' +
      '* Switch: It is a Top-1 routing method proposed by Fedus et al. (2022).\n' +
      '* Soft routing: We use softmax as the routing function \\(g\\), so all experts are activated both during training and inference. While it is likely to provide the best performance, it comes at the expense of increased compute.\n' +
      '* Sample Top-1: We use the gumbel softmax (Jang et al., 2016) for \\(g\\). At training time, we generate a soft sample from the gumbel softmax, but zero out all its values except the largest one. Then we compute only one expert corresponding to this largest value, omitting the other expert computations.\n' +
      '\n' +
      'At inference time, we simply do hard sampling. We anneal the temperature to a sharp distribution at the end of training to gradually reduce the discrepancy between training and inference.\n' +
      '\n' +
      'Splitting ExpertsThe number of modules in the MoE layer matches the number of domains we train on, since each module corresponds to one domain. However, we can increase the number of modules in a simple way by splitting each domain FF sublayer into multiple chunks. Given \\(N\\) domains and an FF activation size of \\(d_{\\text{FF}}\\), we split each FF layer into \\(C\\) chunks with a dimension of \\(d_{\\text{FF}}/C\\). As a result, the final MoE layer will have \\(MC\\) modules.\n' +
      '\n' +
      'Blending ExpertsInstead of directly initializing MoE experts from domain experts in a one-to-one way, we also try including all domains in each MoE expert. The motivation behind this is an observation that MoE experts trained in a standard way do not show domain specialization, but rather are activated uniformly across different domains (Jiang et al., 2024). In contrast, our domain experts are specialized to a specific domain through their training data. To break this domain specialization, we split each domain expert\'s FF layers into \\(N\\) chunks and then merge the \\(n\\)-th chunks from all domains to build the \\(n\\)-th MoE expert. This way, each MoE expert contains the same amount of parameters from all domains.\n' +
      '\n' +
      '## 4 Experiments\n' +
      '\n' +
      '### Experimental Setup\n' +
      '\n' +
      'We base our experiments on the setup used for Llama-2 pretraining (Touvron et al., 2023). In particular, we use the Llama-2 7B model as our seed model.\n' +
      '\n' +
      '#### 4.1.1 BTX Training\n' +
      '\n' +
      'We use the pretrained Llama-2 (Touvron et al., 2023) with 7B parameters as our seed model. After making three copies of the seed model Llama-2 7B, we continue training them on the following domain datasets to derive three domain experts:\n' +
      '\n' +
      '* **Math:** The same data sources and mixture used in Llemma (Azerbayev et al., 2023) model training. To be comparable to Llemma, we train on the same amount of data as well, i.e. 48k steps with 201B tokens in total.\n' +
      '* **Code:** The same data sources and mixture of code data used in CodeLlama pretraining (Roziere et al., 2023). The code expert LLM is trained for 50k steps with 210B tokens in total to be comparable with the math expert.\n' +
      '* **Wikipedia:** Wikipedia documents extracted between June to August 2022. The data was preprocessed to remove hyperlinks, comments and other formatting boilerplate. Since this is a smaller dataset, we train a total of 42B tokens.\n' +
      '\n' +
      'While we can proceed with only these three domain experts, we also include the original seed LLM as a "generalist" expert so that its general knowledge is transferred to the final model. Thus we mix these four expert models into a single MoE model as described in Section3.2. Then we finetune this MoE model on all the data sources used to train the four experts (including the original Llama-2 7B pretraining data for the generalist expert) and train for another 80B tokens. The detailed sampling ratio across datasets in each domain as well as across the domains is described in AppendixA. For BTX with default Top-2 routing, we use load balancing with \\(\\alpha=0.01\\), unless otherwise stated. For the Sample Top-1 routing, we use the temperature annealing schedule \\(\\tau\\)=max\\((0.5,-rt)\\) from Jang et al. (2016) with \\(r=1e-4\\) where \\(t\\) is the number of training steps. For the first layer only, we used soft-routing instead. Since the Sample Top-1 training is more efficient than Top-2, with the same compute budget it can train 160B tokens.\n' +
      '\n' +
      '#### 4.1.2 Baselines\n' +
      '\n' +
      'We compare to the following baselines:* **Llama-2:** We compare to the original Llama-2 7B that we use as a seed model, as well as Llama-2 13B.\n' +
      '* **Dense:** Instead of training separate LLMs on different domain datasets, the dense baseline continues to train the seed LLM with all the data. We use exactly the same training data as BTX, first training on the new domain-specific data used in the experts training stage, followed by the same data mixture that includes the Llama-2 pretraining data in the MoE finetuning stage. We call this comparison _data-matching_ (DM).\n' +
      '* **Sparse upcycling:** This baseline (Komatsuzaki et al., 2022) initializes a MoE model from the seed model by making 4 identical copies of the feedforward module as experts. We use the Top-2 router with randomly initialized \\(W_{i}\\) parameters. In addition to training a data matching baseline with the same data as is used in BTX and the dense baseline, we also train a sparse upcycling baseline with the same amount of GPU-days, i.e. compute-matching (CM), using the MoE finetuning data mixture throughout training. This is equivalent to a special case of BTX which does not contain embarrassingly parallel expert training.\n' +
      '* **Branch-Train-Merge (BTM):** This baseline (Li et al., 2022) uses the same expert LLMs as BTX (including the original seed model) but uses them directly without building a MoE model. For a given context (input), it selects Top-k expert LLMs based on the similarity between the context and experts\' training data. Following the efficient inference method used in Gururangan et al. (2023), both context and experts\' training data are embedded via tf-idf. Top-k experts are selected based on cosine similarity to the mean tf-idf embedding of each expert.\n' +
      '* **CodeLlama 7B:** A language model specializing in code (Roziere et al., 2023) by continued training of the same seed model Llama-2 7B on code data. It also has other features such as long-context and infilling.\n' +
      '* **Llema 7B:** A language model specializing in mathematics (Azerbayev et al., 2023) by continued training of CodeLlama 7B on math data.\n' +
      '\n' +
      'We use the same optimization hyperparameters for training of the baselines, expert models and MoE models. We use the AdamW optimizer with weight decay 0.1, and anneal the learning rate to the peak of \\(1e-4\\) with 100 steps of warmup, and decay to 10% of the peak with a cosine schedule. We use a batch size of 4M tokens with a sequence length of 4096.\n' +
      '\n' +
      '#### 4.1.3 Evaluation\n' +
      '\n' +
      'For evaluation, we use the zero- and few-shot performance on multiple benchmarks that test different skills:\n' +
      '\n' +
      '* Math: we report the average performance on GSM8K (8 shot) (Cobbe et al., 2021) and MATH (4 shot) (Hendrycks et al., 2021) for math reasoning.\n' +
      '* Code: we report the average performance of HumanEval (0 shot) (Chen et al., 2021) and MBPP (3 shot) (Austin et al., 2021) for code generation.\n' +
      '\n' +
      '\\begin{table}\n' +
      '\\begin{tabular}{l c c c c c c c} \\hline \\hline  & \\multicolumn{2}{c}{**Math**} & \\multicolumn{2}{c}{**Code**} & \\multicolumn{2}{c}{**General knowledge**} \\\\ \\cline{2-9}  & **GSM8K** & **MATH** & **Human** & **MBPP** & **Natural** & **Trivia** & **MMLU** \\\\  & & & **Eval** & & **Questions** & **QA** & \\\\ \\hline Llama-2 7B & 14.7 & 2.5 & 12.8 & 20.8 & 16.4 & **58.5** & 46.1 \\\\ Math expert & **39.5** & **18.8** & 25.0 & 33.6 & 14.4 & 37.1 & **52.0** \\\\ Code expert & 12.0 & 4.0 & **31.7** & **40.2** & 11.5 & 29.9 & 39.6 \\\\ Wikipedia expert & 11.7 & 3.1 & 11.0 & 15.2 & **21.8** & 57.2 & 43.1 \\\\ \\hline \\hline \\end{tabular}\n' +
      '\\end{table}\n' +
      'Table 1: Individual domain expert LLM performance on representative tasks, compared to the seed model Llama-2 7B. As expected, the code and math experts excel at their corresponding domain tasks. The Wikipedia expert performs better on Natural Questions, but the math expert has the best score on MMLU. This could be because MMLU contains many math subjects and math training is shown to help on this task (Shao et al., 2024).\n' +
      '\n' +
      '* World knowledge: we report the average performance of Natural Questions (5 shot)(Kwiatkowski et al., 2019) and TriviaQA (5 shot) (Joshi et al., 2017).\n' +
      '* Reasoning: we report the average 0-shot performance of ARC-Easy and ARC-Challenge (Clark et al., 2018), SIQA (Sap et al., 2019), PIQA (Bisk et al., 2020) and WinoGrande (Sakaguchi et al., 2021).\n' +
      '* General: we report performance on MMLU (5 shot) (Hendrycks et al., 2021) which covers multiple domains.\n' +
      '\n' +
      '### Main Results\n' +
      '\n' +
      '#### 4.2.1 Overall Performance\n' +
      '\n' +
      'Domain experts excel at their respective tasks.We first analyze how expert LLMs specialize to specific domains. Results are summarized in Table 1. As expected, individual expert LLMs achieve the best performance in their respective domain, where the math and code domains see especially large improvements. In addition, there are several interesting observations. We see that the math expert training improved its code performance as well, indicating a close relation of these domains. However, such single-domain continued training also suffers from catastrophic forgetting with significant performance drops on some tasks in other domains. For example, the math and code expert are much worse on TriviaQA than the seed model.\n' +
      '\n' +
      'BTX improves all tasks where experts specialize.Table 2 and Figure 2 (right) show aggregated performance across multiple domains. More detailed per-task results are reported in Table 8 in the Appendix. Compared to the seed model Llama-2 7B, BTX models (both Sample Top-1 and Top-2 corresponding to different number of active parameters) improve on all expert domains, such as math, coding and world knowledge without regressing on other tasks such as commonsense reasoning. BTX with Top-2 experts (our default) also approaches the best performance of the specialized models Llama 7B and CodeLlama 7B in the math and coding domains, while drastically improving over those models on domains that are not their speciality such as world knowledge and commonsense reasoning. Compared to alternative data-matching (DM) methods for continued pretraining such as dense and sparse upcycling, BTX achieves better performance on average with small gaps in the math and coding domains. BTX outperforms BTM by a large margin on average, indicating that MoE finetuning to learn token-level routing is beneficial. Overall, the results demonstrate that BTX is a more compute efficient method for continued pretraining which is robust to task interference from multi-task learning. BTX also outperforms Llama-2 13B on all tasks except reasoning, even though Llama-2 13B uses significantly more training compute and has slightly more active parameters.\n' +
      '\n' +
      'We further compare BTX with the sparse upcycling baseline in the compute-matching (CM) scenario. Both\n' +
      '\n' +
      '\\begin{table}\n' +
      '\\begin{tabular}{l c c c c c c} \\hline \\hline  & **Math** & **Code** & **Knowledge** & **Reasoning** & **MMLU** & **Average** \\\\ \\hline \\hline _Specialized LLMs_ & & & & & & \\\\ CodeLlama 7B & 8.1 & 36.3 & 22.2 & 56.6 & 38.6 & 37.9 \\\\ Llemma 7B & 28.0 & 33.5 & 17.2 & 38.8 & 33.5 & 32.1 \\\\ \\hline _Generalist LLMs_ & & & & & & \\\\ Llama-2 7B & 8.6 & 16.8 & 37.4 & 63.3 & 46.1 & 40.7 \\\\ Llama-2 13B & 16.3 & 24.5 & 40.0 & **66.1** & 52.8 & 45.4 \\\\ Dense (DM) & 18.3 & 25.8 & 39.6 & 63.3 & 49.8 & 44.5 \\\\ Sparse upcycling (DM), Top-2 & **28.1** & 34.7 & 34.0 & 62.3 & 51.1 & 46.3 \\\\ BTM, Top-1 & 21.3 & 36.4 & 26.5 & 61.0 & 44.3 & 43.1 \\\\ BTM, Top-2 & 21.5 & **36.6** & 26.9 & 61.2 & 44.3 & 43.4 \\\\ BTX, Sample Top-1 & 26.4 & 31.5 & 40.1 & 63.7 & **53.2** & 47.3 \\\\ BTX, Top-2 & 27.4 & 34.0 & **41.0** & 63.5 & 52.5 & **47.9** \\\\ \\hline \\hline \\end{tabular}\n' +
      '\\end{table}\n' +
      'Table 2: Aggregated performance of BTX compared against various baselines, including both generalist and specialized pretrained models, tested on various capabilities aggregated across popular benchmarks. Dense, sparse upcycling, BTM and BTX are trained on exactly the same amount and mixture of data with the exception that BTM does not have the finetuning stage.\n' +
      '\n' +
      'train on the same data mixture during the MoE stage, but differ in terms of the percent of compute spent on MoE training. While sparse cycling performs close behind BTX, the parallel training of experts increases the training throughput of BTX, as is shown in Table 3. As a result, BTX can train with more than \\(2\\times\\) the data than pure MoE given the same training compute budget, and achieves slightly higher average performance across all domains.\n' +
      '\n' +
      '#### 4.2.2 Better compute-performance tradeoff\n' +
      '\n' +
      'We compare BTX with baselines in terms of compute efficiency in Figure 2 (left). The X-axis shows the total training compute starting from the seed model measured in GPU days, which includes the domain expert training and finetuning of the MoE model. The Y-axis measures the overall performance reported in Table 2.\n' +
      '\n' +
      'Better performance than dense and BTMDespite that the MoE training stage uses a fraction of the total training budget in pretraining (for example, Llama-2 pretraining uses 2T tokens), BTX brings steep improvements on general capabilities compared to alternative continued pretraining approaches such as multi-task learning of the dense model and Branch-Train-Merge.\n' +
      '\n' +
      '\\begin{table}\n' +
      '\\begin{tabular}{l c c c c|c c c c c} \\hline \\hline  & MoE & Training & Total compute & \\#tokens & Math & Code & Knowledge & Reasoning & MMLU & Average \\\\  & compute & time (days) & (GPU-days) & (B) & & & & & \\\\ \\hline BTX & 23\\% & 7.8 & 926.1 & 533 & 27.4 & 34.0 & 41.0 & 63.5 & 52.5 & 47.9 \\\\ Sparse upcycling (CM) & 100\\% & 7.9 & 1007.1 & 252 & 28.2 & 30.7 & 41.3 & 62.9 & 52.1 & 47.3 \\\\ \\hline \\hline \\end{tabular}\n' +
      '\\end{table}\n' +
      'Table 3: Comparison between BTX and Sparse upcycling with compute-matching (CM), which is a special case of BTX without the expert training stage as is shown by the first column that 100% of compute is spent on MoE training. We also report total training time, compute and number of training tokens. Comparing both performance on individual domains as well as the average, we can see that BTX has more balanced performance, in addition to higher throughput.\n' +
      '\n' +
      'Figure 2: **Left:** The average performance vs training budget of BTX compared to various baselines, with different active parameters at inference time indicated by circle size. All the models except Llama-2 13B are trained starting from Llama-2 7B using the datasets described in Section 4.1.1. The X-axis shows the total training compute starting from the seed model measured in GPU days1, and the Y-axis is the average score over all the tasks (as computed in Table 2). The BTX models outperform the baselines that started from the same seed model, as well as Llama-2 13B. **Right:** The normalized performance over different domains where the scores are divided by the highest one. We see large improvements for BTX in code (which matches the specialized model) and math tasks compared to the seed model Llama-2 7B, even outperforming the Llama-2 13B model.\n' +
      '\n' +
      'More efficient than sparse upcycling.As a special case of BTX, sparse upcycling without expert training outperforms dense and BTM but not BTX, given the same or larger compute budget. The compute efficiency gains of BTX are from the embarrassingly parallel training of experts before MoE finetuning.\n' +
      '\n' +
      'In terms of the active number of parameters (shown as circle sizes in 2 (left)), the MoE models are similar to the Llama-2 13B model. BTX uses less than half of the additional training compute compared to Llama-2 13B, but demonstrates improved performance on expert domains (math, code, and knowledge) and achieves better overall performance. This indicates that BTX\'s training is more effective for the late stage of pretraining than using the same training protocol throughout the entire of pretraining.\n' +
      '\n' +
      '### Ablations & Analysis\n' +
      '\n' +
      '#### 4.3.1 Ablations of BTX training\n' +
      '\n' +
      'First, we compare the different routing methods with varying amount of active parameters for different amounts of finetuning. For fair comparison, load balancing is not used in any of them. Results are shown in Table 4. For Switch routing, we set its capacity factor to 1.5 (a hard limit after which routed tokens will be dropped). We found the Switch router to be subpar in average performance. The soft routing performs the best, but that is expected since it lacks sparsity and has the highest number of active parameters. Overall, the Top-2 routing gives us a good balance between performance and efficiency.\n' +
      '\n' +
      'We also ablate additional design choices of BTX, with results summarized in Table 5. We found that MoE training without load balancing performs worse on the coding task (HumanEval), but has higher math (GSM8k) accuracy. The routing analysis in the next section will give more insight into this trade-off. Next, freezing the feedforward modules initialized from each expert, and only training the rest of the MoE model has little impact on performance across all tasks. This suggests that individual experts already gained sufficient domain knowledge during the branch-train stage, while the mix (MoE finetuning) stage mainly trains the\n' +
      '\n' +
      '\\begin{table}\n' +
      '\\begin{tabular}{l c c c c} \\hline \\hline \\multirow{2}{*}{**Routing method**} & \\multicolumn{2}{c}{**Active parameters (B)**} & \\multicolumn{1}{c}{**MoE Finetune**} & \\multicolumn{1}{c}{**Average**} \\\\ \\cline{2-5}  & **Training** & **Inference** & **tokens (B)** & **score** \\\\ \\hline \\hline Switch Top-1 & 6.7 & 6.7 & 10 & 24.7 \\\\ Sample Top-1 & 6.7 & 6.7 & 10 & 33.0 \\\\ Top-2 & 11.1 & 11.1 & 10 & 34.6 \\\\ Soft routing & 19.7 & 19.7 & 10 & 35.8 \\\\ \\hline Sample Top-1 & 6.7 & 6.7 & 40 & 35.3 \\\\ Top-2 & 11.1 & 11.1 & 40 & 35.9 \\\\ Soft routing & 19.7 & 19.7 & 40 & 37.3 \\\\ \\hline Sample Top-1 & 6.7 & 6.7 & 160 & 36.9 \\\\ Top-2 & 11.1 & 11.1 & 80 & 37.3 \\\\ \\hline \\hline \\end{tabular}\n' +
      '\\end{table}\n' +
      'Table 4: Ablations on different routing methods during BTX training. Average score is based on performance on representative tasks including GSM8K, HumanEval, Natural Questions, ARC Challenge and MMLU.\n' +
      '\n' +
      '\\begin{table}\n' +
      '\\begin{tabular}{l c c c c c c} \\hline \\hline  & **GSM8K** & **Human** & **Natural** & **ARC** & **MMLU** & **Average** \\\\  & & **Eval** & **Questions** & **Challenge** & & **Score** \\\\ \\hline \\hline BTX & 29.8 & 27.4 & 23.0 & 43.4 & 50.0 & 34.7 \\\\ \\hline no load-balancing (LB) & 34.6 & 19.5 & 23.2 & 44.4 & 51.6 & 34.6 \\\\ no LB \\& freeze experts & 34.8 & 18.3 & 24.1 & 44.9 & 51.4 & 34.7 \\\\ blending experts & 13.9 & 17.1 & 9.9 & 34.1 & 36.2 & 22.2 \\\\ split experts, top-2 of 8 & 22.0 & 20.1 & 16.8 & 39.1 & 41.8 & 28.0 \\\\ split experts, top-4 of 8 & 29.6 & 26.8 & 22.9 & 44.0 & 49.4 & 34.5 \\\\ \\hline \\hline \\end{tabular}\n' +
      '\\end{table}\n' +
      'Table 5: Ablations on different BTX training strategies. All variants are initialized from the same experts and trained for a total of 10B tokens during MoE finetuning.\n' +
      '\n' +
      'other parameters such as averaged weights in the self-attention and the router transformations \\(W_{i}\\).\n' +
      '\n' +
      'We also test our blending and splitting techniques described in Section3.3. The performance across all tasks dropped when experts are mixed, suggesting that domain FF layers cannot be mixed in this way. Splitting each domain FF into \\(C=2\\) chunks to obtain 8 modules in the MoE layer also does not improve performance, even if Top-4 routing is used to match the active number of parameters.\n' +
      '\n' +
      '#### 4.3.2 Routing Analysis\n' +
      '\n' +
      'To gain an in-depth understanding of the performance of BTX, we run model evaluations on downstream tasks and examine the routing decisions among the experts. The results are summarized in Figure3, and we also report detailed ablation results for different BTX setups in AppendixC. Compared to other routing methods, Top-2 routing with load balancing ensures a more uniform distribution of the load between experts. Analyzing the token probability distributions, we observe a shift towards low probability scores across all experts with load balancing, especially closer to the final layers of the model, which contributes to the fair routing. Interestingly, all models without load balance heavily rely on the Math expert, with a low overall contribution from other experts, especially the Code expert. A dead Code expert comes "back to life" with load balancing introduced in training. In fact, it not only becomes visible, but becomes the dominant expert in the math and code domains.\n' +
      '\n' +
      'Examples of the routing decisions for Top-2 with load balancing can be found in the Table6. Overall across math domain tasks, tokens are often routed to the Code and Llama-2 7B experts. If we look at a more detailed token distribution (AppendixC, Figure6), we find that the GSM8K task prefers Code and Llama-2 experts, while the MATH task relies more on the in-domain Math expert. We hypothesise that this happens because the GSM8K dataset consists of grade school math problems that require common sense knowledge and basic arithmetic operations. Both the Code and World knowledge tasks mostly route to the in-domain Code and Wikipedia experts respectively. As observed earlier in Section4.3.1, when load balancing is introduced, there are improvements in coding tasks but degradation in math tasks, which can be explained with these changes in domain expert routing. The reasoning tasks in contrast exhibit similar behaviour, and rely equally\n' +
      '\n' +
      'Figure 3: BTX routing decisions of the tokens at various layers to different experts (Wiki, Math, Code, LLMaMa-2 7B) for different downstream tasks. The tasks are aggregated by domain: Code (Human Eval, MBPP), Math (GSM8K, MATH), World knowledge (Natural Questions, TriviaQA), and Reasoning (ARC-Easy, ARC-Challenge, SIQA, PIQA, and WinoGrande). We observe that Top-2 routing with load balancing (top) ensures a more uniform distribution of the load between experts compared to Top-2 without load balancing (bottom).\n' +
      '\n' +
      '[MISSING_PAGE_FAIL:11]\n' +
      '\n' +
      'Compared to BTM, BTX provides an approach to finetune the combined experts, which can be directly applied in instruction finetuning or RLHF procedures. However, we leave that for future work as we focused on the pretraining stage in this paper.\n' +
      '\n' +
      'The question of whether experts in MoE are better off specializing in specific domains or not is an interesting one that is worth further investigation. Our approach explicitly tied experts to certain domains, but such specialization does not seem to emerge naturally during MoE training (Jiang et al., 2024). We observed that some experts are used more in their corresponding domain tasks, showing that their domain specialization partially remains even after the MoE finetuning.\n' +
      '\n' +
      'We only compared BTX to two of its special variants, i.e. BTM with 100% compute allocated to expert training and 0% on MoE finetuning, and sparse upcycling with 0% compute allocated to expert training and 100% on MoE finetuning. Future work could perform a thorough sweep of the compute allocation ratio between expert training and MoE training. Also, we did not perform experiments with different data mixtures for MoE finetuning other than uniform sampling.\n' +
      '\n' +
      '## 7 Acknowledgements\n' +
      '\n' +
      'We thank Margaret Li, Kushal Tirumala, Luke Zettlemoyer, Artidoro Pagnoni, Suchin Gururangan, Mike Lewis and Emily Dinan for their discussion and feedback, and Andrew Cohen and Arun Babu for their help with the training implementation.\n' +
      '\n' +
      '## References\n' +
      '\n' +
      '* Achiam et al. (2023) Josh Achiam, Steven Adler, Sandhini Agarwal, Lama Ahmad, Ilge Akkaya, Florencia Leoni Aleman, Diogo Almeida, Janko Altenschmidt, Sam Altman, Shyamal Anadkat, et al. Gpt-4 technical report. _arXiv preprint arXiv:2303.08774_, 2023.\n' +
      '* Aljundi et al. (2016) Rahaf Aljundi, Punarjay Chakravarty, and Tinne Tuytelaars. Expert gate: Lifelong learning with a network of experts. _2017 IEEE Conference on Computer Vision and Pattern Recognition (CVPR)_, pages 7120-7129, 2016. [https://api.semanticscholar.org/CorpusID:914027](https://api.semanticscholar.org/CorpusID:914027).\n' +
      '* Austin et al. (2021) Jacob Austin, Augustus Odena, Maxwell Nye, Maarten Bosma, Henryk Michalewski, David Dohan, Ellen Jiang, Carrie J. Cai, Michael Terry, Quoc V. Le, and Charles Sutton. Program synthesis with large language models. _ArXiv_, abs/2108.07732, 2021. [https://api.semanticscholar.org/CorpusID:237142385](https://api.semanticscholar.org/CorpusID:237142385).\n' +
      '* Awasthi and Sarawagi (2019) Abhijeet Awasthi and Sunita Sarawagi. Continual learning with neural networks: A review. In _Proceedings of the ACM India Joint International Conference on Data Science and Management of Data_, pages 362-365, 2019.\n' +
      '* Azerbayev et al. (2023) Zhangir Azerbayev, Hailey Schoelkopf, Keiran Paster, Marco Dos Santos, Stephen McAleer, Albert Q. Jiang, Jia Deng, Stella Biderman, and Sean Welleck. Llemma: An open language model for mathematics. _ArXiv_, abs/2310.10631, 2023. [https://api.semanticscholar.org/CorpusID:264172303](https://api.semanticscholar.org/CorpusID:264172303).\n' +
      '* Bisk et al. (2020) Yonatan Bisk, Rowan Zellers, Jianfeng Gao, Yejin Choi, et al. Piqa: Reasoning about physical commonsense in natural language. In _Proceedings of the AAAI conference on artificial intelligence_, volume 34, pages 7432-7439, 2020.\n' +
      '* Brown et al. (2020) Tom B. Brown, Benjamin Mann, Nick Ryder, Melanie Subbiah, Jared Kaplan, Prafulla Dhariwal, Arvind Neelakantan, Pranav Shyam, Girish Sastry, Amanda Askell, Sandhini Agarwal, Ariel Herbert-Voss, Gretchen Krueger, T. J. Henighan, Rewon Child, Aditya Ramesh, Daniel M. Ziegler, Jeff Wu, Clemens Winter, Christopher Hesse, Mark Chen, Eric Sigler, Mateusz Litwin, Scott Gray, Benjamin Chess, Jack Clark, Christopher Berner, Sam McCandlish, Alec Radford, Ilya Sutskever, and Dario Amodei. Language models are few-shot learners. _ArXiv_, abs/2005.14165, 2020. [https://api.semanticscholar.org/CorpusID:218971783](https://api.semanticscholar.org/CorpusID:218971783).\n' +
      '* Chen et al. (2021) Mark Chen, Jerry Tworek, Heewoo Jun, Qiming Yuan, Henrique Ponde, Jared Kaplan, Harrison Edwards, Yura Burda, Nicholas Joseph, Greg Brockman, Alex Ray, Raul Puri, Gretchen Krueger, Michael Petrov, Heidy Khlaaf, Girish Sastry, Pamela Mishkin, Brooke Chan, Scott Gray, Nick Ryder, Mikhail Pavlov, Alethea Power, Lukasz Kaiser, Mohammad Bavarian, Clemens Winter, Philippe Tillet, Felipe Petroski Such, David W. Cummings, Matthias Plappert, Fotios Chantzis, Elizabeth Barnes, Ariel Herbert-Voss, William H. Guss, Alex Nichol, Igor Babuschkin, Suchir Balaji, Shantanu Jain, Andrew Carr, Jan Leike, Joshua Achiam, Vedant Misra, Evan Morikawa, Alec Radford, Matthew M. Knight, Miles Brundage, Mira Murati, Katie Mayer, Peter Welinder, Bob McGrew, Dario Amodei, Sam McCandlish, Ilya Sutskever, and Wojciech Zaremba. Evaluating large language models trained on code. _ArXiv_, abs/2107.03374, 2021. [https://api.semanticscholar.org/CorpusID:235755472](https://api.semanticscholar.org/CorpusID:235755472).\n' +
      '* Clark et al. (2018) Peter Clark, Isaac Cowhey, Oren Etzioni, Tushar Khot, Ashish Sabharwal, Carissa Schoenick, and Oyvind Tafjord. Think you have solved question answering? Try ARC, the AI2 reasoning challenge. _arXiv preprint arXiv:1803.05457_, 2018.\n' +
      '* Cobbe et al. (2021) Karl Cobbe, Vineet Kosaraju, Mohammad Bavarian, Mark Chen, Heewoo Jun, Lukasz Kaiser, Matthias Plappert, Jerry Tworek, Jacob Hilton, Reiichiro Nakano, Christopher Hesse, and John Schulman. Training verifiers to solve math word problems. _arXiv preprint arXiv:2110.14168_, 2021.\n' +
      '* Dai et al. (2024) Damai Dai, Chengqi Deng, Chenggang Zhao, R. X. Xu, Huazuo Gao, Deli Chen, Jiashi Li, Wangding Zeng, Xingkai Yu, Y. Wu, Zhenda Xie, Y. K. Li, Panpan Huang, Fuli Luo, Chong Ruan, Zhifang Sui, and Wenfeng Liang. Deepseekmoe: Towards ultimate expert specialization in mixture-of-experts language models. _ArXiv_, abs/2401.06066, 2024. [https://api.semanticscholar.org/CorpusID:266933338](https://api.semanticscholar.org/CorpusID:266933338).\n' +
      '* Douillard et al. (2023) Arthur Douillard, Qixuang Feng, Andrei A. Rusu, Rachita Chhaparia, Yani Donchev, Adhiguna Kuncoro, Marc\'Aurelio Ranzato, Arthur Szlam, and Jiajun Shen. Diloco: Distributed low-communication training of language models. _ArXiv_, abs/2311.08105, 2023. [https://api.semanticscholar.org/CorpusID:265158012](https://api.semanticscholar.org/CorpusID:265158012).\n' +
      '* Fedus et al. (2022) William Fedus, Barret Zoph, and Noam Shazeer. Switch transformers: Scaling to trillion parameter models with simple and efficient sparsity. _The Journal of Machine Learning Research_, 23(1):5232-5270, 2022.\n' +
      '* Team (2023) Gemini Team. Gemini: a family of highly capable multimodal models. _arXiv preprint arXiv:2312.11805_, 2023. Team et al. (2021) Gemini and Anil, Rohan and Borgeaud, Sebastian and Wu, Yonghui and Alayrac, Jean-Baptiste and Yu, Jiahui and Soricut, Radu and Schalkwyk, Johan and Dai, Andrew M and Hauth, Anja and others.\n' +
      '\n' +
      'Suchin Gururangan, Michael Lewis, Ari Holtzman, Noah A. Smith, and Luke Zettlemoyer. Demix layers: Disentangling domains for modular language modeling. In _North American Chapter of the Association for Computational Linguistics_, 2021. [https://api.semanticscholar.org/CorpusID:236976189](https://api.semanticscholar.org/CorpusID:236976189).\n' +
      '* Gururangan et al. [2023] Suchin Gururangan, Margaret Li, Mike Lewis, Weijia Shi, Tim Althoff, Noah A Smith, and Luke Zettlemoyer. Scaling expert language models with unsupervised domain discovery. _arXiv preprint arXiv:2303.14177_, 2023.\n' +
      '* Hendrycks et al. [2021a] Dan Hendrycks, Collin Burns, Steven Basart, Andy Zou, Mantas Mazeika, Dawn Song, and Jacob Steinhardt. Measuring massive multitask language understanding. In _9th International Conference on Learning Representations, ICLR 2021, Virtual Event, Austria, May 3-7, 2021_. OpenReview.net, 2021a. [https://openreview.net/forum?id=47KBjm13GmQ](https://openreview.net/forum?id=47KBjm13GmQ).\n' +
      '* Hendrycks et al. [2021b] Dan Hendrycks, Collin Burns, Saurav Kadavath, Akul Arora, Steven Basart, Eric Tang, Dawn Xiaodong Song, and Jacob Steinhardt. Measuring mathematical problem solving with the math dataset. _ArXiv_, abs/2103.03874, 2021b. [https://api.semanticscholar.org/CorpusID:232134851](https://api.semanticscholar.org/CorpusID:232134851).\n' +
      '* Jacobs et al. [1991] Robert A. Jacobs, Michael I. Jordan, Steven J. Nowlan, and Geoffrey E. Hinton. Adaptive mixtures of local experts. _Neural Computation_, 3:79-87, 1991. [https://api.semanticscholar.org/CorpusID:572361](https://api.semanticscholar.org/CorpusID:572361).\n' +
      '* Jang et al. [2016] Eric Jang, Shixiang Gu, and Ben Poole. Categorical reparameterization with gumbel-softmax. _arXiv preprint arXiv:1611.01144_, 2016.\n' +
      '* Jiang et al. [2022] Albert Q. Jiang, Alexandre Sablayrolles, Antoine Roux, Arthur Mensch, Blanche Savary, Chris Bamford, Devendra Singh Chaplot, Diego de Las Casas, Emma Bou Hanna, Florian Bressand, Gianna Lengyel, Guillaume Bour, Guillaume Lample, L\'elio Renard Lavaud, Lucile Saulnier, Marie-Anne Lachaux, Pierre Stock, Sandeep Subramanian, Sophia Yang, Szymon Antoniak, Teven Le Scao, Theophile Gervet, Thibaut Lavril, Thomas Wang, Timothee Lacroix, and William El Sayed. Mistral of experts. _ArXiv_, abs/2401.04088, 2024. [https://api.semanticscholar.org/CorpusID:266844877](https://api.semanticscholar.org/CorpusID:266844877).\n' +
      '* Joshi et al. [2017] Mandar Joshi, Eunsol Choi, Daniel S. Weld, and Luke Zettlemoyer. Triviaqa: A large scale distantly supervised challenge dataset for reading comprehension. _ArXiv_, abs/1705.03551, 2017. [https://api.semanticscholar.org/CorpusID:26501419](https://api.semanticscholar.org/CorpusID:26501419).\n' +
      '* Komatsuzaki et al. [2022] Aran Komatsuzaki, Joan Puigcerver, James Lee-Thorp, Carlos Riquelme Ruiz, Basil Mustafa, Joshua Ainslie, Yi Tay, Mostafa Dehghani, and Neil Houlsby. Sparse upcycling: Training mixture-of-experts from dense checkpoints. _ArXiv_, abs/2212.05055, 2022. [https://api.semanticscholar.org/CorpusID:254535822](https://api.semanticscholar.org/CorpusID:254535822).\n' +
      '* Kwiatkowski et al. [2019] Tom Kwiatkowski, Jennimaria Palomaki, Olivia Redfield, Michael Collins, Ankur Parikh, Chris Alberti, Danielle Epstein, Illia Polosukhin, Matthew Kelcey, Jacob Devlin, Kenton Lee, Kristina N. Toutanova, Llion Jones, Ming-Wei Chang, Andrew Dai, Jakob Uszkoreit, Quoc Le, and Slav Petrov. Natural questions: a benchmark for question answering research. _Transactions of the Association of Computational Linguistics_, 2019.\n' +
      '* Lange et al. [2019] Matthias De Lange, Rahaf Aljundi, Marc Masana, Sarah Parisot, Xu Jia, Ales Leonardis, Gregory G. Slabaugh, and Tinne Tuytelaars. A continual learning survey: Defying forgetting in classification tasks. _IEEE Transactions on Pattern Analysis and Machine Intelligence_, 44:3366-3385, 2019. [https://api.semanticscholar.org/CorpusID:218889912](https://api.semanticscholar.org/CorpusID:218889912).\n' +
      '* Lewis et al. [2021] Mike Lewis, Shruti Bhosale, Tim Dettmers, Naman Goyal, and Luke Zettlemoyer. Base layers: Simplifying training of large, sparse models. In _International Conference on Machine Learning_, 2021. [https://api.semanticscholar.org/CorpusID:232428341](https://api.semanticscholar.org/CorpusID:232428341).\n' +
      '* Li et al. [2022a] Margaret Li, Suchin Gururangan, Tim Dettmers, Mike Lewis, Tim Althoff, Noah A. Smith, and Luke Zettlemoyer. Branch-train-merge: Embarrassingly parallel training of expert language models. _ArXiv_, abs/2208.03306, 2022a. [https://api.semanticscholar.org/CorpusID:251371375](https://api.semanticscholar.org/CorpusID:251371375).\n' +
      '* 1097, 2022b. [https://api.semanticscholar.org/CorpusID:246527904](https://api.semanticscholar.org/CorpusID:246527904).\n' +
      '* Ouyang et al. [2022] Long Ouyang, Jeff Wu, Xu Jiang, Diogo Almeida, Carroll L. Wainwright, Pamela Mishkin, Chong Zhang, Sandhini Agarwal, Katarina Slama, Alex Ray, John Schulman, Jacob Hilton, Fraser Kelton, Luke E. Miller, Maddie Simens, Amanda Askell, Peter Welinder, Paul Francis Christiano, Jan Leike, and Ryan J. Lowe. Training language models to follow instructions with human feedback. _ArXiv_, abs/2203.02155, 2022. [https://api.semanticscholar.org/CorpusID:246426909](https://api.semanticscholar.org/CorpusID:246426909).\n' +
      '* Ouyang et al. [2022]Stephen Roller, Sainbayar Sukhbaatar, Arthur Szlam, and Jason Weston. Hash layers for large sparse models. In _Neural Information Processing Systems_, 2021. [https://api.semanticscholar.org/CorpusID:235367626](https://api.semanticscholar.org/CorpusID:235367626).\n' +
      '* Roziere et al. (2023) Baptiste Roziere, Jonas Gehring, Fabian Gloeckle, Sten Sootla, Itai Gat, Xiaoqing Tan, Yossi Adi, Jingyu Liu, Tal Remez, Jeremy Rapin, Artyom Kozhevnikov, I. Evtimov, Joanna Bitton, Manish P Bhatt, Cristian Canton Ferrer, Aaron Grattafiori, Wenhan Xiong, Alexandre D\'efossez, Jade Copet, Faisal Azhar, Hugo Touvron, Louis Martin, Nicolas Usunier, Thomas Scialom, and Gabriel Synnaeve. Code llama: Open foundation models for code. _ArXiv_, abs/2308.12950, 2023. [https://api.semanticscholar.org/CorpusID:261100919](https://api.semanticscholar.org/CorpusID:261100919).\n' +
      '* Rusu et al. (2016) Andrei A. Rusu, Neil C. Rabinowitz, Guillaume Desjardins, Hubert Soyer, James Kirkpatrick, Koray Kavukcuoglu, Razvan Pascanu, and Raia Hadsell. Progressive neural networks. _ArXiv_, abs/1606.04671, 2016. [https://api.semanticscholar.org/CorpusID:15350923](https://api.semanticscholar.org/CorpusID:15350923).\n' +
      '* Sakaguchi et al. (2021) Keisuke Sakaguchi, Ronan Le Bras, Chandra Bhagavatula, and Yejin Choi. Winogrande: An adversarial winograd schema challenge at scale. _Communications of the ACM_, 64(9):99-106, 2021.\n' +
      '* Sap et al. (2019) Maarten Sap, Hannah Rashkin, Derek Chen, Ronan LeBras, and Yejin Choi. Socialiqa: Commonsense reasoning about social interactions. _arXiv preprint arXiv:1904.09728_, 2019.\n' +
      '* Shao et al. (2024) Zhihong Shao, Peiyi Wang, Qihao Zhu, R. X. Xu, Jun-Mei Song, Mingchuan Zhang, Y. K. Li, Yu Wu, and Daya Guo. Deepseekmath: Pushing the limits of mathematical reasoning in open language models. _ArXiv_, abs/2402.03300, 2024. [https://api.semanticscholar.org/CorpusID:267412607](https://api.semanticscholar.org/CorpusID:267412607).\n' +
      '* Shazeer et al. (2017) Noam M. Shazeer, Azalia Mirhoseini, Krzysztof Maziarz, Andy Davis, Quoc V. Le, Geoffrey E. Hinton, and Jeff Dean. Outrageously large neural networks: The sparsely-gated mixture-of-experts layer. _ArXiv_, abs/1701.06538, 2017. [https://api.semanticscholar.org/CorpusID:12462234](https://api.semanticscholar.org/CorpusID:12462234).\n' +
      '* Touvron et al. (2023) Hugo Touvron, Louis Martin, Kevin Stone, Peter Albert, Amjad Almahairi, Yasmine Babaei, Nikolay Bashlykov, Soumya Batra, Prajwal Bhargava, Shruti Bhosale, Dan Bikel, Lukas Blecher, Cristian Canton Ferrer, Moya Chen, Guillem Cucurull, David Esiobu, Jude Fernandes, Jeremy Fu, Wenyin Fu, Brian Fuller, Cynthia Gao, Vedanuj Goswami, Naman Goyal, Anthony Hartshorn, Saghar Hosseini, Rui Hou, Hakan Inan, Marcin Kardas, Viktor Kerkez, Madian Khabsa, Isabel Kloumann, Artem Korenev, Punit Singh Koura, Marie-Anne Lachaux, Thibaut Lavril, Jenya Lee, Diana Liskovich, Yinghai Lu, Yuning Mao, Xavier Martinet, Todor Mihaylov, Pushkar Mishra, Igor Molybog, Yixin Nie, Andrew Poulton, Jeremy Reizenstein, Rashi Rungta, Kalyan Saladi, Alan Schelten, Ruan Silva, Eric Michael Smith, Ranjan Subramanian, Xiaoqing Ellen Tan, Binh Tang, Ross Taylor, Adina Williams, Jian Xiang Kuan, Puxin Xu, Zheng Yan, Iliyan Zarov, Yuchen Zhang, Angela Fan, Melanie Kambadur, Sharan Narang, Aurelien Rodriguez, Robert Stojnic, Sergey Edunov, and Thomas Scialom. Llama 2: Open foundation and fine-tuned chat models, 2023.\n' +
      '* Wortsman et al. (2022) Mitchell Wortsman, Gabriel Ilharco, Samir Yitzhak Gadre, Rebecca Roelofs, Raphael Gontijo-Lopes, Ari S. Morcos, Hongseok Namkoong, Ali Farhadi, Yair Carmon, Simon Kornblith, and Ludwig Schmidt. Model soups: averaging weights of multiple fine-tuned models improves accuracy without increasing inference time. _ArXiv_, abs/2203.05482, 2022. [https://api.semanticscholar.org/CorpusID:247362886](https://api.semanticscholar.org/CorpusID:247362886).\n' +
      '* Xue et al. (2024) Fuzhao Xue, Zian Zheng, Yao Fu, Jinjie Ni, Zangwei Zheng, Wangchunshu Zhou, and Yang You. Openmoe: An early effort on open mixture-of-experts language models. _arXiv preprint arXiv:2402.01739_, 2024.\n' +
      '* Zhang et al. (2015) Sixin Zhang, Anna E Choromanska, and Yann LeCun. Deep learning with elastic averaging sgd. In C. Cortes, N. Lawrence, D. Lee, M. Sugiyama, and R. Garnett, editors, _Advances in Neural Information Processing Systems_, volume 28. Curran Associates, Inc., 2015. [https://proceedings.neurips.cc/paper_files/paper/2015/file/d18f655c3fce66ca401d5f38b48c89af-Paper.pdf](https://proceedings.neurips.cc/paper_files/paper/2015/file/d18f655c3fce66ca401d5f38b48c89af-Paper.pdf).\n' +
      '* Zhang et al. (2022) Susan Zhang, Stephen Roller, Naman Goyal, Mikel Artetxe, Moya Chen, Shuohui Chen, Christopher Dewan, Mona T. Diab, Xian Li, Xi Victoria Lin, Todor Mihaylov, Myle Ott, Sam Shleifer, Kurt Shuster, Daniel Simig, Punit Singh Koura, Anjali Sridhar, Tianlu Wang, and Luke Zettlemoyer. Opt: Open pre-trained transformer language models. _ArXiv_, abs/2205.01068, 2022. [https://api.semanticscholar.org/CorpusID:248496292](https://api.semanticscholar.org/CorpusID:248496292).\n' +
      '* Zhao et al. (2024) Jun Zhao, Zhihao Zhang, Qi Zhang, Tao Gui, and Xuanjing Huang. Llama beyond english: An empirical study on language capability transfer. _arXiv preprint arXiv:2401.01055_, 2024.\n' +
      '\n' +
      '## Appendix A Data mixture\n' +
      '\n' +
      'Table 7 shows the exact data mixture ratios used in training each domain expert. For finetuning the MoE model, we sample datasets that used to train math expert, code expert, wikipedia expert and the original Llama-2 7B with probabilities 30.16%, 40.31%, 10.30% and 19.23%.\n' +
      '\n' +
      '## Appendix B Evaluation\n' +
      '\n' +
      'We use the same evaluation metrics as is used in Touvron et al. (2023) and Roziere et al. (2023): for code tasks (HumanEval and MBPP) we report pass@1, for math tasks (GSM8k and MATH) and knowledge tasks (Natural Questions and TriviaQA) we report exact match, we report accuracy for MMLU and ARC. We use greedy decoding for all generations. Detailed results on all tasks are reported in Table 8.\n' +
      '\n' +
      '## Appendix C Routing analysis\n' +
      '\n' +
      'Layer-by-layer comparison of the routing decision for different router designs and downstream tasks aggregated by task domain is shown in Figure 4. Routing distributions slightly vary in the first few layers, but quickly become indistinguishable from layer to layer. One exception is in Switch routing where Math expert becomes dominant across tasks in the last model layer.\n' +
      '\n' +
      '\\begin{table}\n' +
      '\\begin{tabular}{l l l} \\hline \\hline Domain & Dataset & Sampling ratio (\\%) \\\\ \\hline \\multirow{4}{*}{Math} & AlgebraicStack & 13.57 \\\\  & OpenWebMath & 54.27 \\\\  & Arxiv & 27.14 \\\\  & Github & 2.99 \\\\  & Commoncrawl & 5.01 \\\\ \\hline \\multirow{2}{*}{Code} & Code & 82.18 \\\\  & Natural language related to code & 9.90 \\\\  & Natural language & 6.93 \\\\ \\hline \\multirow{2}{*}{Wikipedia} & Wikipedia & 90.91 \\\\  & Commoncrawl & 9.09 \\\\ \\hline \\hline \\end{tabular}\n' +
      '\\end{table}\n' +
      'Table 7: Data sources and weights for domain experts.\n' +
      '\n' +
      '\\begin{table}\n' +
      '\\begin{tabular}{l c c c c c c c c c c c c} \\hline \\hline  & GSM8K & MATH & Human & MBPP & Natural & Trivia & ARC-e & ARC-c & Wino & SIQA & PIQA & MMLU \\\\  & & Eval & & & Questions & QA & & & & & \\\\ \\hline \\multicolumn{11}{l}{_Specialized LLMs_} \\\\ CodeLlama 7B & 13.0 & 3.3 & 31.1 & 41.4 & 11.5 & 32.8 & 67.4 & 34.0 & 62.7 & 46.1 & 72.9 & 38.6 \\\\ Llamma 7B & 39.3 & 16.7 & 25.6 & 41.4 & 9.4 & 24.9 & 28.7 & 26.8 & 50.1 & 37.3 & 51.0 & 33.5 \\\\ \\hline \\multicolumn{11}{l}{_General ILMs_} \\\\ Llama-2 7B & 14.7 & 2.5 & 12.8 & 20.8 & 16.4 & 58.5 & 76.4 & 43.8 & 69.2 & 48.3 & 78.8 & 46.1 \\\\ Llama-2 13B & 28.7 & 3.9 & 18.3 & 30.6 & 16.1 & 63.8 & 77.3 & 49.4 & 73.0 & 50.1 & 80.8 & 52.8 \\\\ Dense (DM) & 26.7 & 9.9 & 20.7 & 30.8 & 24.0 & 55.3 & 76.7 & 44.5 & 68.9 & 48.3 & 78.2 & 49.8 \\\\ Sparse upcveling (DM), Top-2 & 37.3 & 18.9 & 29.3 & 40.2 & 18.8 & 49.2 & 76.3 & 43.4 & 66.4 & 47.3 & 77.9 & 51.1 \\\\ Sparse upcveling (CM), Top-2 & 40.1 & 16.2 & 26.2 & 35.2 & 24.5 & 58.2 & 75.6 & 44.7 & 69.1 & 47.1 & 78.0 & 52.1 \\\\ BTM, Top-1 & 27.4 & 15.2 & 30.8 & 41.9 & 15.0 & 38.0 & 72.8 & 38.1 & 68.4 & 47.8 & 77.9 & 44.3 \\\\ BTM, Top-2 & 27.7 & 15.3 & 30.6 & 42.6 & 15.3 & 38.5 & 73.1 & 38.5 & 68.3 & 48.0 & 78.1 & 44.3 \\\\ BTX, sample Top-1 & 36.9 & 15.8 & 25.6 & 37.4 & 23.7 & 56.4 & 76.7 & 45.0 & 70.6 & 48.0 & 78.2 & 53.2 \\\\ BTX, Top-2 & 37.1 & 17.8 & 28.7 & 39.4 & 24.8 & 57.1 & 76.9 & 45.6 & 67.9 & 48.7 & 78.7 & 52.5 \\\\ \\hline \\hline \\end{tabular}\n' +
      '\\end{table}\n' +
      'Table 8: Individual task performance of BTX and baselines.\n' +
      '\n' +
      'We observe that Code expert is a dominant force in Code domain in Top-2 routing with load balancing. Note the difference with other models where load balancing is not added, and Math expert prevails across domains. We look at Code domain closer and compare routing probability distribution for models with and without load balancing in Figure 5. On the bottom three graphs of the picture we can observe a phenomena of the dead expert, where routing probability to Code expert shifted to 0, while with load balancing added, probability distributions across experts look more similar, with slightly higher expectations for the Code expert.\n' +
      '\n' +
      'To understand if experts specialize in other domains, we look closer at per-task distribution. Routing decision of the tokens in Math and Reasoning domains are shown in Figure 6. We observe that GSM8K task prefers Code and Llama-2 experts, while Math task more relies on in-domain expert. We hypothesise that this happens because GSM8K dataset consists of grade school math word problems that require common sense knowledge and basic arithmetic operations, while Math task requires college-level math knowledge, and more aligned with Math expert\'s training data. In the Reasoning domain, all tasks exhibit similar behaviour and equally rely on Math and generalist LLM\'s expertise.\n' +
      '\n' +
      '## Appendix AFigure 4: BTX routing decisions of the tokens at various layers to different experts (Wiki, Math, Code, LLaMa-2 7B) for different downstream tasks. The tasks are aggregated by domain: Code (Human Eval, MBPP), Math (GSM8K, MATH), World knowledge (Natural Questions, TriviaQA), and Reasoning (ARC-Easy, ARC-Challenge, SIQA, PIQA, and WinoGrande). We observe that top-2 routing with load balancing ensures more uniform distribution of the load between experts compared to the other routing methods across all layers.\n' +
      '\n' +
      'Figure 5: Routing probabilities per expert across different layers for Human Eval task. We compare top-2 routing with (left) and without load balancing (right).\n' +
      '\n' +
      'Figure 6: Routing decision of the tokens in Math and Reasoning domains. We observe that GSM8K task prefers Code and Llama-2 experts, while MATH task relies more on in-domain expert. In the Reasoning domain, the load is distributed between Math and LLaMa-2 7B experts.\n' +
      '\n';
  </script>
  <style>
    #content {
      max-width: 800px;
      margin: auto;
    }
  </style>
  <script>
    let script = document.createElement('script');
    script.src = "https://cdn.jsdelivr.net/npm/mathpix-markdown-it@1.0.40/es5/bundle.js";
    document.head.append(script);

    script.onload = function() {
      const isLoaded = window.loadMathJax();
      if (isLoaded) {
        console.log('Styles loaded!')
      }

      const el = window.document.getElementById('content-text');
      if (el) {
        const options = {
          htmlTags: true
        };
        const html = window.render(text, options);
        el.outerHTML = html;
      }
    };
  </script>
</head>
<body>
  <div id="content"><div id="content-text"></div></div>
</body>
</html>